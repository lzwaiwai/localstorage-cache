{"version":3,"file":"localstorage-cache.js","sources":["libs/sizeof.js","libs/index.js"],"sourcesContent":["// http://www.alloyteam.com/2013/12/js-calculate-the-number-of-bytes-occupied-by-a-string/\nvar sizeof = function(obj, charset){\n    var str = JSON.stringify(obj);\n    var total = 0,\n        charCode,\n        i,\n        len;\n    charset = charset ? charset.toLowerCase() : '';\n    if(charset === 'utf-16' || charset === 'utf16'){\n        for(i = 0, len = str.length; i < len; i++){\n            charCode = str.charCodeAt(i);\n            if(charCode <= 0xffff){\n                total += 2;\n            }else{\n                total += 4;\n            }\n        }\n    }else{\n        for(i = 0, len = str.length; i < len; i++){\n            charCode = str.charCodeAt(i);\n            if(charCode <= 0x007f) {\n                total += 1;\n            }else if(charCode <= 0x07ff){\n                total += 2;\n            }else if(charCode <= 0xffff){\n                total += 3;\n            }else{\n                total += 4;\n            }\n        }\n    }\n    return total;\n}\nexport default sizeof;","import sizeof from './sizeof';\n\nconst CACHE = 'storage_cache';\nconst MARKS = 'storage_marks';\nconst CREATEAT = 'c';\nconst UPDATEAT = 'u'\nconst EXPIRE = 'e';\nconst TIMES = 't';\n\nclass LocalStorageCache {\n  constructor(size, strategy, charset) {\n    const _storage = localStorage.getItem(CACHE) || '{}';\n    const storage = JSON.parse(_storage);\n\n    const _marks = localStorage.getItem(MARKS) || '{}';\n    const marks = JSON.parse(_marks);\n\n    this.storage = storage;\n    this.marks = marks;\n    this.strategy = strategy || 'LRU';\n    this.charset = charset;\n\n    if (size > 3 * 1024) {\n      throw new Error('3MB is the upper limit of size')\n    }\n\n    this.size = (size || 2 * 1024) * 1024;\n  }\n\n  _getValue(key) {\n    return this.storage[key];\n  }\n\n  _setValue(key, value) {\n    this.storage[key] = value;\n    localStorage.setItem(CACHE, JSON.stringify(this.storage));\n  }\n\n  _getMarks(key) {\n    return this.marks[key];\n  }\n\n  _setMarks(key, value) {\n    this.marks[key] = value;\n    localStorage.setItem(MARKS, JSON.stringify(this.marks));\n  }\n\n  _remove(key) {\n    if (this.storage[key])  {\n      delete this.storage[key];\n      localStorage.setItem(CACHE, JSON.stringify(this.storage));\n    }\n\n    if (this.marks[key]) {\n      delete this.marks[key];\n      localStorage.setItem(MARKS, JSON.stringify(this.marks));\n    }\n  }\n\n  _clear() {\n    localStorage.removeItem(CACHE);\n    localStorage.removeItem(MARKS);\n  }\n\n  _overflow(key, value, expire) {\n    const newItemSize = sizeof({[key]: value}, this.charset);\n    if (newItemSize >= this.size) {\n      throw new Error(`the size of ${key} is bigger than cache\\'s`);\n    }\n\n    const itemMark = this._getMarks(key);\n    const newItemMark = {\n      [CREATEAT]: new Date().getTime(),\n      [UPDATEAT]: new Date().getTime()\n    };\n\n    if (expire) {\n      newItemMark[EXPIRE] = expire;\n    }\n\n    if (!itemMark) {\n      newItemMark[TIMES] = 0;\n    }\n\n    const storageSize = sizeof(this.storage, this.charset);\n    if (newItemSize + storageSize < this.size) { // size is enough\n      this._setMarks(key, newItemMark);\n      return;\n    }\n\n    let keys = Object.keys(this.marks);\n    const v = this.strategy === 'LFU' ? TIMES : UPDATEAT;\n    keys = keys.sort((a, b) => this.marks[a][v] < this.marks[b][v]);\n\n    while (newItemSize + sizeof(this.storage, this.charset) >= this.size) {\n      const _key = keys.pop();\n\n      delete this.storage[_key];\n      delete this.marks[_key];\n    }\n    this._setMarks(key, newItemMark);\n  }\n\n  getCache(key) {\n    if (!key) {\n      throw new Error('missing arguments!');\n    }\n\n    const itemMark = this._getMarks(key);\n    const value = this._getValue(key);\n\n    if (!value) {\n      return undefined;\n    }\n\n    if (itemMark[EXPIRE] && itemMark[EXPIRE] * 1000 + itemMark[CREATEAT] < new Date().getTime()) { // expired\n      this._remove(key);\n      return undefined;\n    }\n\n    itemMark[UPDATEAT] = new Date().getTime();\n    ++itemMark[TIMES];\n\n    this._setMarks(key, itemMark);\n\n    return value;\n  }\n\n  setCache(key, value, expire) {\n    if (!key || !value) {\n      throw new Error('missing arguments!');\n    }\n\n    this._overflow(key, value, expire);\n    this._setValue(key, value);\n    return this;\n  }\n\n  deleteCache(key) {\n    if (!key) {\n      throw new Error('missing arguments!');\n    }\n\n    this._remove(key);\n    return this;\n  }\n\n  clearCache() {\n    this._clear();\n    return this;\n  }\n};\n\nwindow.LocalStorageCache = LocalStorageCache;\nexport default LocalStorageCache;\n"],"names":["sizeof","obj","charset","str","JSON","stringify","total","charCode","i","len","toLowerCase","length","charCodeAt","CACHE","MARKS","CREATEAT","UPDATEAT","EXPIRE","TIMES","LocalStorageCache","size","strategy","_storage","localStorage","getItem","storage","parse","_marks","marks","Error","key","value","setItem","removeItem","expire","newItemSize","itemMark","_getMarks","newItemMark","Date","getTime","storageSize","_setMarks","keys","Object","v","sort","a","b","_key","pop","_getValue","undefined","_remove","_overflow","_setValue","_clear","window"],"mappings":"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"}