{"version":3,"file":"localstorage-cache.js","sources":["libs/sizeof.js","libs/index.js"],"sourcesContent":["var sizeof = function(object) {\n    var objectList = [];\n    var stack = [object];\n    var bytes = 0;\n\n    while (stack.length) {\n        var value = stack.pop();\n\n        if(typeof value === 'boolean'){\n            bytes += 4;\n        }else if(typeof value === 'string'){\n            bytes += value.length * 2;\n        }else if(typeof value === 'number'){\n            bytes += 8;\n        }else if(typeof value === 'object' && objectList.indexOf( value ) === -1){\n            objectList.push(value);\n            // if the object is not an array, add the sizes of the keys\n            if (Object.prototype.toString.call(value) != '[object Array]'){\n                for(var key in value) bytes += 2 * key.length;\n            }\n            for(var key in value) stack.push(value[key]);\n        }\n    }\n    return bytes;\n}\nexport default sizeof;","import sizeof from './sizeof';\n\nconst CACHE = 'storage_cache';\nconst MARKS = 'storage_marks';\nconst CREATEAT = 'c';\nconst UPDATEAT = 'u'\nconst EXPIRE = 'e';\nconst TIMES = 't';\n\nclass LocalStorageCache {\n  constructor(size, strategy) {\n    const _storage = localStorage.getItem(CACHE) || '{}';\n    const storage = JSON.parse(_storage);\n\n    const _marks = localStorage.getItem(MARKS) || '{}';\n    const marks = JSON.parse(_marks);\n\n    this.storage = storage;\n    this.marks = marks;\n    this.strategy = strategy || 'LRU';\n\n    if (size > 3 * 1024) {\n      throw new Error('超过最大空间（3MB）限制！')\n    }\n\n    this.size = (size || 2 * 1024) * 1024;\n  }\n\n  _getValue(key) {\n    return this.storage[key];\n  }\n\n  _setValue(key, value) {\n    this.storage[key] = value;\n    localStorage.setItem(CACHE, JSON.stringify(this.storage));\n  }\n\n  _getMarks(key) {\n    return this.marks[key];\n  }\n\n  _setMarks(key, value) {\n    this.marks[key] = value;\n    localStorage.setItem(MARKS, JSON.stringify(this.marks));\n  }\n\n  _remove(key) {\n    if (this.storage[key])  {\n      delete this.storage[key];\n      localStorage.setItem(CACHE, JSON.stringify(this.storage));\n    }\n\n    if (this.marks[key]) {\n      delete this.marks[key];\n      localStorage.setItem(MARKS, JSON.stringify(this.marks));\n    }\n  }\n\n  _clear() {\n    localStorage.removeItem(CACHE);\n    localStorage.removeItem(MARKS);\n  }\n\n  _overflow(key, value, expire) {\n    const newItemSize = sizeof({[key]: value});\n    if (newItemSize >= this.size) {\n      throw new Error('单次缓存的数据大于缓存整体空间大小！');\n    }\n\n    const itemMark = this._getMarks(key);\n    const newItemMark = {\n      [CREATEAT]: new Date().getTime(),\n      [UPDATEAT]: new Date().getTime()\n    };\n\n    if (expire) {\n      newItemMark[EXPIRE] = expire;\n    }\n\n    if (!itemMark) {\n      newItemMark[TIMES] = 0;\n    }\n\n    const storageSize = sizeof(this.storage);\n    if (newItemSize + storageSize < this.size) { // 缓存空间足够\n      this._setMarks(key, newItemMark);\n      return;\n    }\n\n    let keys = Object.keys(this.marks);\n    const v = this.strategy === 'LFU' ? TIMES : UPDATEAT;\n    keys = keys.sort((a, b) => this.marks[a][v] < this.marks[b][v]);\n\n    while (newItemSize + sizeof(this.storage) >= this.size) {\n      const _key = keys.pop();\n\n      delete this.storage[_key];\n      delete this.marks[_key];\n    }\n    this._setMarks(key, newItemMark);\n  }\n\n  getCache(key) {\n    if (!key) {\n      throw new Error('missing arguments!');\n    }\n\n    const itemMark = this._getMarks(key);\n    const value = this._getValue(key);\n\n    if (!value) {\n      return undefined;\n    }\n\n    if (itemMark[EXPIRE] && itemMark[EXPIRE] * 1000 + itemMark[CREATEAT] < new Date().getTime()) { // 已过期\n      this._remove(key);\n      return undefined;\n    }\n\n    itemMark[UPDATEAT] = new Date().getTime();\n    ++itemMark[TIMES];\n\n    this._setMarks(key, itemMark);\n\n    return value;\n  }\n\n  setCache(key, value, expire) {\n    if (!key || !value) {\n      throw new Error('missing arguments!');\n    }\n\n    this._overflow(key, value, expire);\n    this._setValue(key, value);\n    return this;\n  }\n\n  deleteCache(key) {\n    if (!key) {\n      throw new Error('missing arguments!');\n    }\n\n    this._remove(key);\n    return this;\n  }\n\n  clearCache() {\n    this._clear();\n    return this;\n  }\n};\n\nwindow.LocalStorageCache = LocalStorageCache;\nexport default LocalStorageCache;\n"],"names":["sizeof","object","objectList","stack","bytes","length","value","pop","indexOf","push","Object","prototype","toString","call","key","CACHE","MARKS","CREATEAT","UPDATEAT","EXPIRE","TIMES","LocalStorageCache","size","strategy","_storage","localStorage","getItem","storage","JSON","parse","_marks","marks","Error","setItem","stringify","removeItem","expire","newItemSize","itemMark","_getMarks","newItemMark","Date","getTime","storageSize","_setMarks","keys","v","sort","a","b","_key","_getValue","undefined","_remove","_overflow","_setValue","_clear","window"],"mappings":"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"}